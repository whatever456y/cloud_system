name: Docker Build and Push
on:
 push:
  branches: [ "main" ]
# 这是⼀个重要的设置：定义 GITHUB_TOKEN 的权限 
# 我们需要写⼊ Packages 的权限来推送镜像 
permissions:
 contents: read
 packages: write
 
jobs:
 # 第⼀步：测试代码 
  test:
   runs-on: ubuntu-latest
   steps:
   - name: Checkout repository
     uses: actions/checkout@v4
     
   - name: Setup Node.js
     uses: actions/setup-node@v4
     with:
      node-version: '18'
     
   - name: Install dependencies
     run: npm install
     
   - name: Run tests
     run: npm test
     
# 第⼆步：构建并推送 Docker 镜像
  build-and-push:
   needs: test # 只有测试通过才运⾏ 
   runs-on: ubuntu-latest
   steps:
   - name: Checkout repository
     uses: actions/checkout@v4

 # 设置 Docker Buildx 环境 (Docker 官⽅推荐)
   - name: Set up Docker Buildx
     uses: docker/setup-buildx-action@v3
     
 # 登录到 GitHub Container Registry (ghcr.io) 
 
 # ${{ secrets.GITHUB_TOKEN }} 是 GitHub ⾃动⽣成的密钥，⽆需⼿动设置 
   - name: Log in to the Container registry
     uses: docker/login-action@v3
     with:
      registry: ghcr.io
      username: ${{ github.actor }}
      password: ${{ secrets.GITHUB_TOKEN }}
      
 # 构建并推送 
   - name: Build and push Docker image
     uses: docker/build-push-action@v5
     with:
      context: .
      push: true
      # 注意：镜像名称必须全部⼩写 
      tags: ghcr.io/${{ github.repository_owner }}/ci-cd-practice:latest

  notify:
    needs: [test, build-and-push] 
    runs-on: ubuntu-latest
    # 即使前面的作业失败，这个作业也运行
    if: always()
    steps:
      - name: Send Discord notification
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: |
            {
              "username": "GitHub Actions Bot",
              "avatar_url": "https://github.githubassets.com/images/modules/logos_page/Octocat.png",
              "content": "",
              "embeds": [{
                "title": "Docker Build and Push #${{ github.run_number }}",
                "description": "Workflow **${{ github.workflow }}** triggered by **${{ github.actor }}**",
                "color": ${{ job.status == 'success' && '3066993' || '15158332' }},
                "fields": [
                  {
                    "name": "Status",
                    "value": "${{ job.status }}",
                    "inline": true
                  },
                  {
                    "name": "Branch",
                    "value": "${{ github.ref_name }}",
                    "inline": true
                  },
                  {
                    "name": "Commit",
                    "value": "[${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})",
                    "inline": false
                  }
                ],
                "timestamp": "${{ github.event.head_commit.timestamp }}",
                "footer": {
                  "text": "Repository: ${{ github.repository }}"
                }
              }]
            }
